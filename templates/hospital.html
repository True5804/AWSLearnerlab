<!DOCTYPE html>
<html>
<head>
  <title>Hospital Panel - BloodChain</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
	.upload-area {
		border: 2px dashed #ccc;
		padding: 40px 20px;
		border-radius: 8px;
		cursor: pointer;
		background-color: #fdfdfd;
		transition: 0.3s;
	}
	.upload-area:hover {
		background-color: #f7f7f7;
	}
	.file-input {
		position: absolute;
		top: 0; left: 0;
		width: 100%; height: 100%;
		opacity: 0;
		cursor: pointer;
	}
	.upload-button {
		z-index: 1;
	}
	.loading-spinner {
		width: 40px;
		height: 40px;
		border: 5px solid #f3f3f3;
		border-top: 5px solid #0066cc;
		border-radius: 50%;
		animation: spin 1s linear infinite;
	}
	@keyframes spin {
		0% { transform: rotate(0); }
		100% { transform: rotate(360deg); }
	}
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light px-4">
        <div class="container-fluid">
          <a href="javascript:void(0)" class="navbar-brand fw-bold" onclick="goToHome()">Blood Management System</a>
          <div class="d-flex ms-auto">
            <ul class="navbar-nav">
              <li class="nav-item"><a class="nav-link" href="/suppliers">Suppliers</a></li>
              <li class="nav-item"><a class="nav-link" href="/hospitals">Hospitals</a></li>
              <li class="nav-item"><a class="nav-link" href="/track">Track Blood</a></li>
			  <li class="nav-item"><a class="nav-link" href="/files">Files</a></li>
			  <li class="nav-item"><a class="nav-link text-danger fw-bold" href="/logout">Logout</a></li>
            </ul>
          </div>
        </div>
    </nav>

  <div class="container mt-4">
		<h2>Hospital Panel</h2>
		<hr>

		<ul class="nav nav-tabs" id="hospitalTabs">
		<li class="nav-item">
			<a class="nav-link active" data-bs-toggle="tab" href="#giveBlood">Use Blood</a>
		</li>
		<li class="nav-item">
			<a class="nav-link" data-bs-toggle="tab" href="#requestBlood">Request Blood</a>
		</li>
		<li class="nav-item" role="presentation">
			<a class="nav-link" data-bs-toggle="tab" href="#changePwd">Change Password</a>
		</li>
		<li class="nav-item">
			<a class="nav-link" data-bs-toggle="tab" href="#uploadTab">üìÅ Upload File</a>
		</li>
		</ul>

		<div class="tab-content mt-4 text-center" style="max-width: 500px; margin: 0 auto;">
			<div class="tab-pane fade show active" id="giveBlood">

				<div class="form-group mb-3">
				<label for="bloodId" class="form-label fw-bold">Blood ID *</label>
				<input class="form-control text-center" id="bloodId">
				</div>

				<div class="form-group mb-3">
				<label for="patientName" class="form-label fw-bold">Patient Name *</label>
				<input class="form-control text-center" id="patientName">
				</div>

				<div class="form-group mb-3">
				<label for="patientAge" class="form-label fw-bold">Age *</label>
				<input class="form-control text-center" id="patientAge">
				</div>

				<div class="form-group mb-3">
				<label for="patientPhone" class="form-label fw-bold">Phone Number *</label>
				<input class="form-control text-center" id="patientPhone">
				</div>

				<div class="form-group mb-4">
				<label for="bloodGroup" class="form-label fw-bold">Blood Group *</label>
				<select class="form-select text-center" id="bloodGroup">
					<option value="" disabled selected>Select</option>
					<option value="A+">A+</option>
					<option value="A-">A-</option>
					<option value="B+">B+</option>
					<option value="B-">B-</option>
					<option value="AB+">AB+</option>
					<option value="AB-">AB-</option>
					<option value="O+">O+</option>
					<option value="O-">O-</option>
				</select>
				</div>

				<button class="btn btn-primary" onclick="giveBlood()">Submit</button>
			</div>

			<div class="tab-pane fade" id="requestBlood">

				<div class="form-group mb-3">
				<label for="reqBloodGroup" class="form-label fw-bold">Blood Group *</label>
				<select class="form-select text-center" id="reqBloodGroup">
					<option value="" disabled selected>Select</option>
					<option value="A+">A+</option>
					<option value="A-">A-</option>
					<option value="B+">B+</option>
					<option value="B-">B-</option>
					<option value="AB+">AB+</option>
					<option value="AB-">AB-</option>
					<option value="O+">O+</option>
					<option value="O-">O-</option>
				</select>
				</div>

				<div class="form-group mb-4">
				<label for="reqAmount" class="form-label fw-bold">Amount (ml) *</label>
				<input class="form-control text-center" id="reqAmount">
				</div>

				<button class="btn btn-warning" onclick="requestBlood()">Request</button>
			</div>

			<div class="tab-pane fade" id="changePwd">
				<div style="max-width: 400px; margin: 0 auto;">
					<div class="form-group mb-3">
					<label class="form-label fw-bold">Old Password</label>
					<input type="password" class="form-control text-center" id="oldPassword">
					</div>
					<div class="form-group mb-3">
					<label class="form-label fw-bold">New Password</label>
					<input type="password" class="form-control text-center" id="newPassword">
					</div>
					<button class="btn btn-warning w-100" onclick="changePassword()">Update Password</button>
				</div>
			</div>

			<div class="tab-pane fade" id="uploadTab">
				<div class="container py-4">
					<h4 class="mb-3">Upload Documents (PDF / CSV / Image)</h4>

					<div class="upload-area border border-secondary rounded p-4 text-center position-relative">
					<input type="file" id="fileInput" class="file-input" accept=".pdf,.csv,image/*">
					<button class="upload-button btn btn-primary">Select File</button>
					<p class="mt-2">Or drag your file here</p>
					</div>

					<div class="loading mt-3 text-center" style="display: none;">
					<div class="loading-spinner mx-auto mb-2"></div>
					<p>Uploading... Please hold</p>
					</div>

					<div class="upload-status alert mt-3" id="uploadStatus" style="display: none;"></div>
				</div>
			</div>
		</div>
  	</div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    async function giveBlood() {
		const id = document.getElementById('bloodId').value;
		const name = document.getElementById('patientName').value;
		const age = document.getElementById('patientAge').value;
		const phone = document.getElementById('patientPhone').value; 
		const blood = document.getElementById('bloodGroup').value;

		try {

			const patientData = {
				usedBloodID: id,
				patientName: name,
				age: age,
				phone_number: phone,
				bloodGroup: blood,
				usedTime: new Date().toISOString().slice(0, 19).replace('T', ' ')
			};

			const res = await fetch('/api/add_patient', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(patientData)
			});

			const result = await res.json();
			if (result.success) {
				alert('‚úÖ Blood usage recorded and patient saved');
			} else {
				alert('‚ùå ' + result.message);
			}
		} catch (err) {
			console.error(err);
			alert('‚ùå Error occurred during blood usage');
		}
	}

    async function requestBlood() {
		const blood = document.getElementById('reqBloodGroup').value;
		const amount = document.getElementById('reqAmount').value;

		try {
			const res = await fetch('/api/request_blood', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({ bloodGroup: blood, amount: amount })
			});
			const result = await res.json();

			if (result.success) {
				alert("‚úÖ Blood requested & marked as shipped: ID = " + result.blood_id);
			} else {
				alert("‚ùå " + result.message);
			}
		} catch (err) {
			console.error(err);
			alert("‚ùå Blood request failed");
		}
	}

	async function changePassword() {
		const oldPassword = document.getElementById('oldPassword').value;
		const newPassword = document.getElementById('newPassword').value;
		const username = prompt("üîí Please enter your username again:"); // ÊàñÈÄèÈÅé session Êèê‰æõ

		const res = await fetch('/api/change_password', {
			method: 'POST',
			headers: { 'Content-Type': 'application/json' },
			body: JSON.stringify({
			username,
			oldPassword,
			newPassword
			})
		});

		const result = await res.json();
		alert(result.message || (result.success ? 'Password changed' : 'Failed'));
	}

	document.addEventListener('DOMContentLoaded', () => {
		const fileInput = document.getElementById('fileInput');
		const uploadArea = document.querySelector('.upload-area');
		const status = document.getElementById('uploadStatus');
		const loading = document.querySelector('.loading');

		fileInput.addEventListener('change', e => {
			const file = e.target.files[0];
			if (file) uploadFile(file);
		});

		uploadArea.addEventListener('dragover', e => {
			e.preventDefault(); uploadArea.classList.add('bg-light');
		});
		uploadArea.addEventListener('dragleave', e => {
			e.preventDefault(); uploadArea.classList.remove('bg-light');
		});
		uploadArea.addEventListener('drop', e => {
			e.preventDefault();
			uploadArea.classList.remove('bg-light');
			const file = e.dataTransfer.files[0];
			if (file) uploadFile(file);
		});

		function uploadFile(file) {
			const reader = new FileReader();
			const status = document.getElementById('uploadStatus');
			const loading = document.querySelector('.loading');

			loading.style.display = 'block';
			status.style.display = 'none';

			const preview = document.getElementById('imagePreview');
			if (file.type.startsWith('image/')) {
				preview.src = URL.createObjectURL(file);
				preview.classList.remove('d-none');
			} else {
				preview.classList.add('d-none');
			}


			// Á¨¨‰∫åÂÄã reader Ë≤†Ë≤¨‰∏äÂÇ≥
			const uploadReader = new FileReader();
			uploadReader.onload = async function (e) {
				const base64Data = e.target.result.split(',')[1]; // ÁßªÈô§ data:image/...base64,
				const contentType = file.type || 'application/octet-stream';
				const payload = {
					key: base64Data,
					filename: file.name,
					content_type: contentType
				};

				try {
					const res = await fetch('https://sn2kap4yjb.execute-api.us-east-1.amazonaws.com/default/API2Lambda', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(payload)
					});

					const text = await res.text();
					const result = (text.startsWith('{')) ? JSON.parse(text) : text;

					status.className = 'upload-status alert alert-success';
					status.textContent = '‚úÖ File uploaded successfully';
					if (typeof result === 'string') {
						status.innerHTML += `<br><a href="${result}" target="_blank">${result}</a>`;
					} else if (result.url) {
						status.innerHTML += `<br><a href="${result.url}" target="_blank">${result.url}</a>`;
					}
				} catch (err) {
					status.className = 'upload-status alert alert-danger';
					status.textContent = '‚ùå Upload failed: ' + err.message;
				} finally {
					status.style.display = 'block';
					loading.style.display = 'none';
				}
			};
			uploadReader.readAsDataURL(file);
		}


	});

	function goToHome() {
		const role = localStorage.getItem('role');
		if (role === 'admin') {
			window.location.href = '/admin';
		} else if (role === 'supplier') {
			window.location.href = '/supplier';
		} else if (role === 'hospital') {
			window.location.href = '/hospital';
		} else {
			window.location.href = '/';  // fallback: index.html
		}
	  }

	function logout() {
      localStorage.removeItem('role');
      window.location.href = '/logout';
    }
  </script>
</body>
</html>
