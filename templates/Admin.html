<!DOCTYPE html>
<html>
<head>
  <title>Admin Panel - BloodChain</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
	.table-responsive {
		max-width: 100%;
		overflow-x: auto;}
  </style>

</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light bg-light px-4">
      <div class="container-fluid">
        <a href="javascript:void(0)" class="navbar-brand fw-bold" onclick="goToHome()">Blood Management System</a>
        <div class="d-flex ms-auto">
          <ul class="navbar-nav">
            <li class="nav-item"><a class="nav-link" href="/suppliers">Suppliers</a></li>
            <li class="nav-item"><a class="nav-link" href="/hospitals">Hospitals</a></li>
            <li class="nav-item"><a class="nav-link" href="/track">Track Blood</a></li>
			<li class="nav-item"><a class="nav-link" href="/files">Files</a></li>
			<li class="nav-item"><a class="nav-link text-danger fw-bold" href="/logout">Logout</a></li>
          </ul>
        </div>
      </div>
    </nav>

  <div class="container mt-4">
    <h2>Admin Panel</h2>
    <hr>

    <ul class="nav nav-tabs" id="adminTabs">
      <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#addSupplier">Add Suppliers</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#addHospital">Add Hospitals</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#viewDonors">View Donors</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#viewPatients">View Patients</a></li>
	  <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#uploadTab">üìÅ Upload File</a>
		</li>
    </ul>

    <div class="tab-content mt-4 text-center">

      <div class="tab-pane fade show active" id="addSupplier">
		<div style="max-width: 400px; margin: 0 auto;">
			<div class="form-group mb-3">
			<label for="supplierName" class="form-label fw-bold">Supplier Name *</label>
			<input type="text" class="form-control text-center" id="supplierName">
			</div>
			<div class="form-group mb-4">
			<label for="supplierPhone" class="form-label fw-bold">Tel Number *</label>
			<input type="text" class="form-control text-center" id="supplierPhone">
			</div>
			<div class="form-group mb-4">
			<label for="supplierPhone" class="form-label fw-bold">Login Username*</label>
			<input type="text" class="form-control text-center" id="supplierUsername">
			</div>
			<div class="form-group mb-4">
			<label for="supplierPhone" class="form-label fw-bold">Login Password*</label>
			<input type="text" class="form-control text-center" id="supplierPassword">
			</div>
			<button class="btn btn-primary" onclick="addSupplier()">Add</button>
		</div>
      </div>

	  <div class="tab-pane fade" id="addHospital">
		<div style="max-width: 400px; margin: 0 auto;">
			<div class="form-group mb-3">
			<label for="hospitalName" class="form-label fw-bold">Hospital Name *</label>
			<input type="text" class="form-control text-center" id="hospitalName">
			</div>
			<div class="form-group mb-3">
			<label for="hospitalAddress" class="form-label fw-bold">Hospital Address *</label>
			<input type="text" class="form-control text-center" id="hospitalAddress">
			</div>
			<div class="form-group mb-4">
			<label for="hospitalPhone" class="form-label fw-bold">Tel Number *</label>
			<input type="text" class="form-control text-center" id="hospitalPhone">
			</div>
			<div class="form-group mb-4">
			<label for="hospitalPhone" class="form-label fw-bold">Login Username*</label>
			<input type="text" class="form-control text-center" id="hospitalUsername">
			</div>
			<div class="form-group mb-4">
			<label for="hospitalPhone" class="form-label fw-bold">Login Password*</label>
			<input type="text" class="form-control text-center" id="hospitalPassword">
			</div>
		  	<button class="btn btn-primary w-100" onclick="addHospital()">Add Hospital</button>
		</div>
      </div>
      

      <div class="tab-pane fade" id="viewDonors">
        <button class="btn btn-outline-secondary mb-3" onclick="getDonors()">Fetch Donors Data</button>
			<div class="table-responsive">
			<table id="donorTable" class="table table-bordered w-100">
				<thead class="table-light">
				<tr>
					<th>Donor Name</th>
					<th>Age</th>
					<th>Gender</th>
					<th>Phone Number</th>
					<th>Blood Group</th>
					<th>Blood Volume (ml)</th>
					<th>Blood ID</th>
					<th>Donated Time</th>
				</tr>
				</thead>
				<tbody></tbody>
			</table>
			</div>
      </div>

      <div class="tab-pane fade" id="viewPatients">
        <button class="btn btn-outline-secondary mb-3" onclick="getPatients()">Fetch Patients Data</button>
			<div class="table-responsive">
			<table id="patientTable" class="table table-bordered w-100">
				<thead class="table-light">
				<tr>
					<th>Patient Name</th>
					<th>Age</th>
					<th>Phone Number</th>
					<th>Used BloodID</th>
					<th>Blood Group</th>
					<th>Used Time</th>
				</tr>
				</thead>
				<tbody></tbody>
			</table>
			</div>
      </div>

	  <div class="tab-pane fade" id="uploadTab">
			<div class="container py-4">
				<h4 class="mb-3">Upload Documents (PDF / CSV / Image)</h4>

				<div class="upload-area border border-secondary rounded p-4 text-center position-relative">
					<input type="file" id="fileInput" class="file-input" accept=".pdf,.csv,image/*">
					<button class="upload-button btn btn-primary">Select File</button>
					<p class="mt-2">Or drag your file here</p>
				</div>

				<div class="loading mt-3 text-center" style="display: none;">
					<div class="loading-spinner mx-auto mb-2"></div>
					<p>Uploading... Please hold</p>
				</div>

				<div class="upload-status alert mt-3" id="uploadStatus" style="display: none;"></div>
			</div>
		</div>
    </div>
  </div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    async function addSupplier() {
      const data = {
        supplierName: document.getElementById('supplierName').value,
        supplierPhone: document.getElementById('supplierPhone').value,
        username: document.getElementById('supplierUsername').value,
        password: document.getElementById('supplierPassword').value,
      };
      const res = await fetch('/api/add_supplier', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const result = await res.json();
      if (result.success === false && result.status?.includes("exists")) {
			alert("‚ö†Ô∏è This account already exists, please change another user name!");
		} else {
			alert(result.status || '‚úÖ Supplier added successfully');
		}
    }

    async function addHospital() {
      const data = {
        hospitalAddress: document.getElementById('hospitalAddress').value,
        hospitalName: document.getElementById('hospitalName').value,
        hospitalPhone: document.getElementById('hospitalPhone').value,
        username: document.getElementById('hospitalUsername').value,
        password: document.getElementById('hospitalPassword').value,
      };
      const res = await fetch('/api/add_hospital', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const result = await res.json();
      alert(result.status || 'Done');
    }

    async function getDonors() {
		const response = await fetch('/api/donors');
		const donors = await response.json();
		const table = document.querySelector('#donorTable tbody');
		table.innerHTML = "";

		donors.forEach(d => {
			const row = document.createElement('tr');
			row.innerHTML = `
			<td>${d.donorName}</td>
			<td>${d.age}</td>
			<td>${d.gender}</td>
			<td>${d.phone_number}</td>
			<td>${d.bloodGroup}</td>
			<td>${d.bloodVolume}</td>
			<td>${d.bloodUniqueId}</td>
			<td>${new Date(d.donatedTime).toLocaleString()}</td>
			`;
			table.appendChild(row);
		});
	}

    async function getPatients() {
		const response = await fetch('/api/patients');
		const patients = await response.json();
		const table = document.querySelector('#patientTable tbody');
		table.innerHTML = "";

		patients.forEach(p => {
			const row = document.createElement('tr');
			row.innerHTML = `
			<td>${p.patientName}</td>
			<td>${p.age}</td>
			<td>${p.phone_number}</td>
			<td>${p.bloodGroup}</td>
			<td>${p.usedBloodId}</td>
			<td>${new Date(p.usedTime).toLocaleString()}</td>
			`;
			table.appendChild(row);
		});
	}

	document.addEventListener('DOMContentLoaded', () => {
		const fileInput = document.getElementById('fileInput');
		const uploadArea = document.querySelector('.upload-area');
		const status = document.getElementById('uploadStatus');
		const loading = document.querySelector('.loading');

		fileInput.addEventListener('change', e => {
			const file = e.target.files[0];
			if (file) uploadFile(file);
		});

		uploadArea.addEventListener('dragover', e => {
			e.preventDefault(); uploadArea.classList.add('bg-light');
		});
		uploadArea.addEventListener('dragleave', e => {
			e.preventDefault(); uploadArea.classList.remove('bg-light');
		});
		uploadArea.addEventListener('drop', e => {
			e.preventDefault();
			uploadArea.classList.remove('bg-light');
			const file = e.dataTransfer.files[0];
			if (file) uploadFile(file);
		});

		function uploadFile(file) {
			const reader = new FileReader();
			const status = document.getElementById('uploadStatus');
			const loading = document.querySelector('.loading');

			loading.style.display = 'block';
			status.style.display = 'none';

			// È°ØÁ§∫ÂúñÁâáÈ†êË¶ΩÔºàÂ¶ÇÊûúÊòØÂúñÁâáÔºâ
			if (file.type.startsWith('image/')) {
				const preview = document.getElementById('imagePreview') || document.createElement('img');
				preview.id = 'imagePreview';
				preview.className = 'image-preview';
				document.querySelector('.upload-area').appendChild(preview);

				reader.onload = function (e) {
					preview.src = e.target.result;
					preview.style.display = 'block';
				};
				reader.readAsDataURL(file);
			}

			// Á¨¨‰∫åÂÄã reader Ë≤†Ë≤¨‰∏äÂÇ≥
			const uploadReader = new FileReader();
			uploadReader.onload = async function (e) {
				const base64Data = e.target.result.split(',')[1]; // ÁßªÈô§ data:image/...base64,
				const contentType = file.type || 'application/octet-stream';
				const payload = {
					key: base64Data,
					filename: file.name,
					content_type: contentType
				};

				try {
					const res = await fetch('https://sn2kap4yjb.execute-api.us-east-1.amazonaws.com/default/API2Lambda', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify(payload)
					});

					const text = await res.text();
					const result = (text.startsWith('{')) ? JSON.parse(text) : text;

					status.className = 'upload-status alert alert-success';
					status.textContent = '‚úÖ File uploaded successfully';
					if (typeof result === 'string') {
						status.innerHTML += `<br><a href="${result}" target="_blank">${result}</a>`;
					} else if (result.url) {
						status.innerHTML += `<br><a href="${result.url}" target="_blank">${result.url}</a>`;
					}
				} catch (err) {
					status.className = 'upload-status alert alert-danger';
					status.textContent = '‚ùå Upload failed: ' + err.message;
				} finally {
					status.style.display = 'block';
					loading.style.display = 'none';
				}
			};
			uploadReader.readAsDataURL(file);
		}


	});

	function goToHome() {
		const role = localStorage.getItem('role');
		if (role === 'admin') {
			window.location.href = '/admin';
		} else if (role === 'supplier') {
			window.location.href = '/supplier';
		} else if (role === 'hospital') {
			window.location.href = '/hospital';
		} else {
			window.location.href = '/';  // fallback: index.html
		}
	}

	function logout() {
		localStorage.removeItem('role');
		window.location.href = '/logout';
	}
  </script>
</body>
</html>
